<!--/*~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  ~ Copyright 2016 Adobe
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~*/-->
<template data-sly-template.footer="${ @ page, pwa }">
    <sly data-sly-use.clientlib="/libs/granite/sightly/templates/clientlib.html"
         data-sly-test.clientlibCategoriesJsBody="${page.clientLibCategoriesJsBody}"
         data-sly-call="${clientlib.js @ categories=clientlibCategoriesJsBody}"></sly>
    <sly data-sly-include="customfooterlibs.html"></sly>
    <sly data-sly-resource="${'cloudservices' @ resourceType='cq/cloudserviceconfigs/components/servicecomponents'}"></sly>
    <sly data-sly-test="${page.hasCloudconfigSupport}" data-sly-resource="${'cloudconfig-footer' @ resourceType='cq/cloudconfig/components/scripttags/footer'}"></sly>
    <sly data-sly-test="${page.data}" data-sly-call="${clientlib.js @ categories='core.wcm.components.commons.datalayer.v1'}"></sly>
    <sly data-sly-list="${page.htmlPageItems}"><script data-sly-test="${item.location.name == 'footer'}"
            data-sly-element="${item.element.name @ context='unsafe'}" data-sly-attribute="${item.attributes}"></script>
    </sly>
    <sly data-sly-test="${pwa.pWAEnabled}">
        <style>
            #snackbar {
                visibility: hidden;
                min-width: 250px;
                margin-left: -125px;
                background-color: #333;
                color: #fff;
                text-align: center;
                border-radius: 2px;
                padding: 16px;
                position: fixed;
                z-index: 1;
                left: 50%;
                bottom: 30px;
            }

            #snackbar.show {
                visibility: visible;
                -webkit-animation: fadein 0.5s;
                animation: fadein 0.5s;
            }

            @-webkit-keyframes fadein {
                from {
                    bottom: 0;
                    opacity: 0;
                }
                to {
                    bottom: 30px;
                    opacity: 1;
                }
            }

            @keyframes fadein {
                from {
                    bottom: 0;
                    opacity: 0;
                }
                to {
                    bottom: 30px;
                    opacity: 1;
                }
            }
        </style>
        <div id="snackbar">A new version of this app is available. Click <a id="reload" href="#">here</a> to update.</div>
        <script>
            let newWorker;

            function showUpdateBar() {
                let snackbar = document.getElementById('snackbar');
                snackbar.className = 'show';
            }

            // The click event on the pop up notification
            document.getElementById('reload').addEventListener('click', function(){
                newWorker.postMessage({ action: 'skipWaiting' });
            });

            // Check that service workers are supported
            if ('serviceWorker' in navigator) {
                // Use the window load event to keep the page load performant
                window.addEventListener('load', () => {
                    let serviceWorker = '${pwa.serviceWorkerPath @ context = "text" }';
                    navigator.serviceWorker.register(serviceWorker).then(reg => {
                        reg.addEventListener('updatefound', () => {
                            // An updated service worker has appeared in reg.installing!
                            newWorker = reg.installing;
                            newWorker.addEventListener('statechange', () => {
                                // Has service worker state changed?
                                switch (newWorker.state) {
                                    case 'installed':
                                        // There is a new service worker available, show the notification
                                        if (navigator.serviceWorker.controller) {
                                            console.log('There is a new version of this app available');
                                            showUpdateBar();
                                            // newWorker.postMessage({ action: 'skipWaiting' });
                                        }
                                        break;
                                    default: break;
                                }
                            });
                        });
                    });

                    let refreshing;
                    navigator.serviceWorker.addEventListener('controllerchange', function () {
                        if (refreshing) return;
                        window.location.reload();
                        refreshing = true;
                    });
                });
            }
        </script>
    </sly>
</template>
